---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/page.tsx
  - src/app/(admin)/employees/page.tsx
  - src/app/access-denied/page.tsx
  - src/app/page.tsx
  - src/actions/admin.ts
  - src/components/admin/create-employee-form.tsx
  - src/components/layout/nav-bar.tsx
  - src/components/layout/logout-button.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can create a new employee account from the dashboard"
    - "Employee navigating to /admin/* sees access denied"
    - "Unauthenticated user navigating to any protected route is redirected to /login"
    - "Admin sees admin navigation with employee management link"
    - "Logout button is visible and works from any authenticated page"
  artifacts:
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin-only layout with role check (redirects non-admins)"
      min_lines: 15
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Authenticated layout with nav bar (any role)"
      min_lines: 15
    - path: "src/actions/admin.ts"
      provides: "Server Action for admin to create employee accounts"
      exports: ["createEmployee"]
    - path: "src/app/(admin)/employees/page.tsx"
      provides: "Employee management page with create employee form"
      min_lines: 15
    - path: "src/app/access-denied/page.tsx"
      provides: "Access denied page for unauthorized role access"
      min_lines: 5
    - path: "src/components/layout/logout-button.tsx"
      provides: "Logout button component using logout Server Action"
      min_lines: 10
  key_links:
    - from: "src/app/(admin)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient() to check user role from profiles table"
      pattern: "from.*profiles.*select.*role"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient() to verify authentication"
      pattern: "supabase\\.auth\\.getUser"
    - from: "src/actions/admin.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient() for admin.createUser"
      pattern: "adminClient\\.auth\\.admin\\.createUser"
    - from: "src/actions/admin.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient() to verify caller is admin"
      pattern: "profile\\?.role.*!==.*admin"
    - from: "src/app/page.tsx"
      to: "redirect"
      via: "Root page redirects based on auth + role"
      pattern: "redirect\\("
---

<objective>
Implement role-based access control with route group layouts, create the admin employee creation flow, add navigation with logout, and wire the root redirect logic.

Purpose: Delivers AUTH-04 (admin creates employees) and AUTH-05 (role-based access enforcement). Completes the entire Phase 1 foundation -- after this plan, all 5 success criteria are met.
Output: Admin and dashboard layouts with server-side guards, employee creation form and Server Action, access-denied page, navigation with logout.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create route group layouts with auth guards and navigation</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
    src/app/(admin)/layout.tsx
    src/app/(admin)/page.tsx
    src/app/access-denied/page.tsx
    src/app/page.tsx
    src/components/layout/nav-bar.tsx
    src/components/layout/logout-button.tsx
  </files>
  <action>
    1. Create `src/components/layout/logout-button.tsx`:
       - 'use client' directive.
       - Imports `logout` from `@/actions/auth`.
       - Renders a form with a submit button calling the logout action.
       - Styled as a subtle link or icon button. Use Tailwind.

    2. Create `src/components/layout/nav-bar.tsx`:
       - Server Component that receives `role` and `userName` as props.
       - Shows MPM branding (text logo).
       - For admin role: links to Admin Dashboard (`/admin`), Employees (`/admin/employees`), and Employee View (`/`).
       - For employee role: link to Dashboard (`/`).
       - Always shows the user's name and `<LogoutButton />`.
       - Responsive: horizontal nav on desktop, collapsible on mobile (simple approach -- use details/summary or a toggle state).
       - Styled with the same premium dark theme from the auth layout.

    3. Create `src/app/(dashboard)/layout.tsx`:
       - Server Component.
       - Call `supabase.auth.getUser()`. If no user, `redirect('/login')`.
       - Fetch user profile from profiles table to get role and name.
       - Render `<NavBar role={profile.role} userName={profile.first_name} />` and `{children}`.
       - This layout protects ALL routes under `(dashboard)/`.

    4. Create `src/app/(dashboard)/page.tsx`:
       - Server Component. Employee dashboard placeholder.
       - Show "Welcome, {firstName}" heading.
       - Show role badge (Admin / Employee).
       - Placeholder card: "Your discounts will appear here" (Phase 3 content).
       - If user is admin, show a link to the admin dashboard.

    5. Create `src/app/(admin)/layout.tsx`:
       - Server Component.
       - Call `supabase.auth.getUser()`. If no user, `redirect('/login')`.
       - Fetch profile. If `role !== 'admin'`, `redirect('/access-denied')`.
       - Render `<NavBar role="admin" userName={profile.first_name} />` and `{children}`.
       - This layout protects ALL routes under `(admin)/`.
       - IMPORTANT: Both the auth check AND role check happen server-side. This is security, not just UX.

    6. Create `src/app/(admin)/page.tsx`:
       - Server Component. Admin dashboard placeholder.
       - Show "Admin Dashboard" heading.
       - Placeholder cards: "Employee Management", "Division Management", "Discount Rules" (future phases).
       - Link to `/admin/employees` for the one working feature.

    7. Create `src/app/access-denied/page.tsx`:
       - Simple page showing "Access Denied" message.
       - "You do not have permission to view this page."
       - Link back to `/` (dashboard).
       - Does NOT require authentication (it's a dead-end info page).

    8. Update `src/app/page.tsx` (root page):
       - Server Component.
       - Call `supabase.auth.getUser()`.
       - If no user, `redirect('/login')`.
       - If user exists, fetch profile.
       - If admin, `redirect('/admin')`.
       - If employee, redirect to employee dashboard. Since `(dashboard)/page.tsx` is the catch-all for authenticated users, redirect to a named path or use the dashboard route group. The simplest approach: root page checks auth and role, then redirects to the appropriate landing page. The `(dashboard)/page.tsx` renders at `/` by virtue of the route group, so root just needs to handle the redirect-to-login-if-unauthenticated case and the admin-redirect case.
       - REVISED APPROACH: Make root `page.tsx` the auth+role router. If not logged in -> `/login`. If admin -> `/admin`. If employee -> render the dashboard page content directly (or import from dashboard). Actually, the cleanest pattern: root page.tsx redirects to `/login` if unauthenticated. The `(dashboard)/page.tsx` IS the employee landing page at `/`. The `(admin)/page.tsx` is at `/admin`. So root page.tsx just needs to handle the role-based redirect for admins who hit `/`.

    STYLING: Continue the premium dark theme. Nav bar should be sleek -- dark background, subtle border, gold accent on active links. Cards should have subtle depth (border, slight shadow, hover states).
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Verify `src/app/(admin)/layout.tsx` checks BOTH authentication AND role.
    Verify `src/app/(dashboard)/layout.tsx` checks authentication.
    Verify both layouts use `supabase.auth.getUser()` (NOT getSession).
    Verify `src/app/access-denied/page.tsx` exists.
    Verify logout button exists in nav bar.
  </verify>
  <done>
    Dashboard layout guards authentication. Admin layout guards authentication + admin role. Nav bar shows role-appropriate links with logout. Access denied page exists. Root page handles routing by role.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin employee creation Server Action and page</name>
  <files>
    src/actions/admin.ts
    src/app/(admin)/employees/page.tsx
    src/components/admin/create-employee-form.tsx
  </files>
  <action>
    1. Create `src/actions/admin.ts` with 'use server' directive. Implement `createEmployee`:

       a. Import `createClient` from `@/lib/supabase/server` and `createAdminClient` from `@/lib/supabase/admin`.
       b. Import `z` from `zod`.

       c. Define `CreateEmployeeSchema`:
          - email: z.string().email()
          - firstName: z.string().min(1, "First name is required")
          - lastName: z.string().min(1, "Last name is required")
          - role: z.enum(['employee', 'admin']).default('employee')

       d. `createEmployee(prevState: any, formData: FormData)`:
          - First, verify caller is admin: create server client, call getUser(), fetch profile, check role === 'admin'. Return `{ error: 'Unauthorized' }` if not admin.
          - Validate input with Zod. On validation error, return `{ error: formatted validation message }`.
          - Create admin client. Call `adminClient.auth.admin.createUser({ email, email_confirm: true, user_metadata: { first_name, last_name } })`.
          - On error, return `{ error: 'Failed to create employee. Email may already be in use.' }` (generic message).
          - If role is 'admin', update the profile: `adminClient.from('profiles').update({ role: 'admin' }).eq('id', data.user.id)`.
          - After successful creation, send a password reset email so the new employee can set their password: `adminClient.auth.admin.generateLink({ type: 'magiclink', email, options: { redirectTo: process.env.NEXT_PUBLIC_SITE_URL + '/auth/callback?next=/update-password' } })`. Alternatively, use `resetPasswordForEmail` from the server client. The goal: new employee receives an email to set their initial password.
          - Return `{ success: true, message: 'Employee created. They will receive an email to set their password.' }`.

       IMPORTANT: The admin check is the FIRST thing in the action. Auth check before any business logic.
       IMPORTANT: Use `createAdminClient()` for user creation (service role required).
       IMPORTANT: Error messages to client are generic. Log detailed errors server-side.

    2. Create `src/components/admin/create-employee-form.tsx`:
       - 'use client' directive.
       - Uses `useActionState` from React 19 with `createEmployee` action.
       - Fields: email, firstName, lastName, role (select: employee/admin, default employee).
       - Submit button with loading state (use isPending from useActionState).
       - Display error or success message from action response.
       - On success, clear the form (reset inputs).
       - Styled with the premium dark theme. Input fields, labels, select dropdown.

    3. Create `src/app/(admin)/employees/page.tsx`:
       - Server Component.
       - Page title: "Employee Management".
       - Renders `<CreateEmployeeForm />`.
       - Below the form, placeholder text: "Employee list will appear here" (Phase 2 will add the full CRUD table).
       - NOTE: This page is protected by the `(admin)/layout.tsx` guard -- no need for additional auth checks here.

    4. Verify everything compiles and builds.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Run `npm run build` -- build succeeds.
    Verify `src/actions/admin.ts` has 'use server' directive.
    Verify `createEmployee` checks auth + admin role BEFORE any business logic.
    Verify `createEmployee` uses `createAdminClient()` for user creation.
    Verify `createEmployee` does NOT expose raw Supabase errors to the client.
    Verify form uses `useActionState` from `react` (not `useFormState` from `react-dom`).
  </verify>
  <done>
    Admin can create employee accounts via a form at /admin/employees. Server Action validates admin role, creates user with service-role client, triggers profile creation via database trigger, and sends password setup email. Generic error messages protect internal details.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 authentication and role-based access system:
    1. Login with email/password (AUTH-01)
    2. Password reset flow (AUTH-02)
    3. Logout from any page (AUTH-03)
    4. Admin creates employee accounts (AUTH-04)
    5. Role-based route protection (AUTH-05)
  </what-built>
  <how-to-verify>
    PREREQUISITE: You must have a Supabase project set up with:
    - .env.local populated with real Supabase credentials
    - Migration run against the Supabase database (copy SQL from supabase/migrations/00001_foundation.sql and run in Supabase SQL Editor)
    - Custom Access Token Hook enabled in Supabase Dashboard > Authentication > Hooks
    - At least one admin user seeded (create via Supabase Dashboard > Authentication > Users, then set role to 'admin' in profiles table)

    TEST STEPS:
    1. Run `npm run dev` at http://localhost:3000
    2. Visit http://localhost:3000 -- should redirect to /login (unauthenticated)
    3. Log in with the seeded admin credentials -- should land on admin dashboard
    4. Navigate to /admin/employees -- should see the create employee form
    5. Create a test employee (any email you control)
    6. Log out -- should redirect to /login
    7. Log in as the new employee (use password reset flow if needed)
    8. As employee, navigate to /admin -- should see "Access Denied"
    9. Close browser, reopen, visit localhost:3000 -- should still be logged in (session persistence)
    10. Test password reset: click "Forgot password?" on login page, enter email, check inbox

    WHAT TO LOOK FOR:
    - Auth flows work end-to-end
    - Role-based access is enforced (employee cannot access admin routes)
    - UI looks premium, not generic bootstrap
    - Error messages are user-friendly, not raw errors
    - Loading states work on form submissions
  </how-to-verify>
  <resume-signal>Type "approved" or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Admin layout checks authentication + admin role server-side
4. Dashboard layout checks authentication server-side
5. Both layouts use getUser() not getSession()
6. Create employee action validates admin role before any operation
7. Create employee uses service-role client (createAdminClient)
8. Access denied page exists at /access-denied
9. Navigation shows role-appropriate links
10. Logout works from any authenticated page
</verification>

<success_criteria>
- Unauthenticated users are redirected to /login on any protected route
- Admin can access /admin/* routes; employee sees access denied
- Admin can create new employee accounts via /admin/employees
- New employees receive email to set their password
- Logout redirects to /login
- Navigation shows appropriate links per role
- All 5 Phase 1 success criteria from ROADMAP.md are achievable
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
