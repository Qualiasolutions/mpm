---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/actions/auth.ts
  - src/app/(auth)/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/reset-password/page.tsx
  - src/app/(auth)/update-password/page.tsx
  - src/app/auth/callback/route.ts
  - src/app/auth/confirm/route.ts
  - src/components/auth/login-form.tsx
  - src/components/auth/reset-password-form.tsx
  - src/components/auth/update-password-form.tsx
autonomous: true

must_haves:
  truths:
    - "Employee can log in with email and password"
    - "Employee can request a password reset and receive an email link"
    - "Employee can set a new password after clicking the reset link"
    - "Employee can log out from any page and be redirected to login"
    - "Session persists across browser close and reopen"
  artifacts:
    - path: "src/actions/auth.ts"
      provides: "Server Actions for login, logout, password reset request, password update"
      exports: ["login", "logout", "requestPasswordReset", "updatePassword"]
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with email/password form"
      min_lines: 15
    - path: "src/app/(auth)/reset-password/page.tsx"
      provides: "Password reset request page"
      min_lines: 10
    - path: "src/app/(auth)/update-password/page.tsx"
      provides: "New password entry page (after clicking reset link)"
      min_lines: 10
    - path: "src/app/auth/callback/route.ts"
      provides: "PKCE code exchange handler"
      exports: ["GET"]
    - path: "src/components/auth/login-form.tsx"
      provides: "Client component with form fields, validation, error display"
      min_lines: 40
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "src/actions/auth.ts"
      via: "Server Action call (login)"
      pattern: "login\\("
    - from: "src/actions/auth.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient() for auth operations"
      pattern: "import.*createClient.*from.*lib/supabase/server"
    - from: "src/app/auth/callback/route.ts"
      to: "supabase.auth.exchangeCodeForSession"
      via: "PKCE code exchange"
      pattern: "exchangeCodeForSession"
    - from: "src/actions/auth.ts (requestPasswordReset)"
      to: "supabase.auth.resetPasswordForEmail"
      via: "triggers Supabase email with reset link"
      pattern: "resetPasswordForEmail"
---

<objective>
Build all authentication pages (login, password reset, password update) and their backing Server Actions. Wire the PKCE callback route for code exchange. Implement logout.

Purpose: Delivers AUTH-01 (login + session persistence), AUTH-02 (password reset flow), AUTH-03 (logout from any page). These are the core auth flows every user needs.
Output: Working auth pages and Server Actions. Users can log in, reset passwords, and log out.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth Server Actions and callback route handlers</name>
  <files>
    src/actions/auth.ts
    src/app/auth/callback/route.ts
    src/app/auth/confirm/route.ts
  </files>
  <action>
    1. Create `src/actions/auth.ts` with 'use server' directive. Import `createClient` from `@/lib/supabase/server` and `redirect` from `next/navigation`. Import `z` from `zod`. Implement four Server Actions:

    a. `login(formData: FormData)`:
       - Validate with Zod: email (string, email), password (string, min 6).
       - Call `supabase.auth.signInWithPassword({ email, password })`.
       - On error, return `{ error: error.message }` (generic message, not raw Supabase error).
       - On success, `redirect('/')` (root page will redirect based on role).
       - Do NOT use revalidatePath -- redirect handles cache invalidation.

    b. `logout()`:
       - Call `supabase.auth.signOut()`.
       - `redirect('/login')`.

    c. `requestPasswordReset(formData: FormData)`:
       - Validate email with Zod.
       - Call `supabase.auth.resetPasswordForEmail(email, { redirectTo: process.env.NEXT_PUBLIC_SITE_URL + '/auth/callback?next=/update-password' })`.
       - Return `{ success: true }` regardless of whether email exists (prevent email enumeration).
       - On actual error (network, etc.), return `{ error: 'Something went wrong. Please try again.' }`.

    d. `updatePassword(formData: FormData)`:
       - Validate: password (string, min 6), confirmPassword (string). Check they match.
       - Call `supabase.auth.updateUser({ password })`.
       - On error, return `{ error: error.message }`.
       - On success, `redirect('/')`.

    2. Create `src/app/auth/callback/route.ts`:
       - Export async `GET(request: Request)`.
       - Parse `code` and `next` from searchParams.
       - If `code` exists, call `supabase.auth.exchangeCodeForSession(code)`.
       - On success, redirect to `origin + (next ?? '/')`.
       - On failure or no code, redirect to `/login?error=auth-code-error`.

    3. Create `src/app/auth/confirm/route.ts`:
       - Same pattern as callback but for email confirmation tokens.
       - Parse `token_hash` and `type` from searchParams.
       - Call `supabase.auth.verifyOtp({ type, token_hash })`.
       - Redirect to `/` on success, `/login?error=confirmation-failed` on failure.

    IMPORTANT: All server-side auth uses `supabase.auth.getUser()` for validation, NOT `getSession()`.
    IMPORTANT: Return generic error messages to the client. Never expose Supabase internal errors.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Verify `src/actions/auth.ts` has 'use server' directive at the top.
    Verify all 4 actions exist: login, logout, requestPasswordReset, updatePassword.
    Verify `src/app/auth/callback/route.ts` exports GET and calls `exchangeCodeForSession`.
  </verify>
  <done>
    Four auth Server Actions implemented with Zod validation. PKCE callback and email confirmation route handlers created. Generic error messages returned to client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth pages and form components</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/reset-password/page.tsx
    src/app/(auth)/update-password/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/reset-password-form.tsx
    src/components/auth/update-password-form.tsx
  </files>
  <action>
    1. Create `src/app/(auth)/layout.tsx`:
       - Server Component. Minimal layout with no navigation.
       - Centered content container (flexbox, min-h-screen, centered both axes).
       - Include a subtle MPM branding element (company name or logo placeholder).
       - Use Tailwind for styling. Clean, professional look. NOT generic -- use a distinctive color palette. Suggest dark background (#0A0A0B) with gold/amber accent (#D4A853) for the MPM brand feel (luxury brands distributor).

    2. Create `src/components/auth/login-form.tsx`:
       - 'use client' directive (needs useState for error/loading state).
       - Email input (type="email", required), password input (type="password", required, minLength=6).
       - Submit button with loading state (disabled + spinner while submitting).
       - Error display area (shows error string from Server Action response).
       - Use the `login` Server Action. Use `useActionState` from React 19 (NOT the deprecated `useFormState` from `react-dom`).
       - Link to `/reset-password` below the form ("Forgot password?").
       - Tailwind styling: inputs with focus rings, button with brand accent color, proper spacing.
       - NO self-registration link. Employees are created by admins (AUTH-04).

    3. Create `src/app/(auth)/login/page.tsx`:
       - Server Component. Renders `<LoginForm />`.
       - Page title: "Sign In" or "Employee Login".
       - If URL has `?error=auth-code-error`, show a dismissible error banner.

    4. Create `src/components/auth/reset-password-form.tsx`:
       - 'use client' directive.
       - Email input only.
       - Calls `requestPasswordReset` Server Action.
       - On success, shows "Check your email for a reset link" message (NOT the raw response).
       - Link back to `/login`.

    5. Create `src/app/(auth)/reset-password/page.tsx`:
       - Server Component. Renders `<ResetPasswordForm />`.
       - Page title: "Reset Password".

    6. Create `src/components/auth/update-password-form.tsx`:
       - 'use client' directive.
       - New password input + confirm password input.
       - Client-side check: passwords match before submitting.
       - Calls `updatePassword` Server Action.
       - Error display for mismatched passwords or server errors.

    7. Create `src/app/(auth)/update-password/page.tsx`:
       - Server Component. Renders `<UpdatePasswordForm />`.
       - Page title: "Set New Password".

    IMPORTANT: Use React 19's `useActionState` hook, NOT the deprecated `useFormState` from `react-dom`. The signature is `const [state, formAction, isPending] = useActionState(action, initialState)`. Import from `react`, not `react-dom`.

    IMPORTANT: Forms should use the `action` attribute with the formAction from useActionState, enabling progressive enhancement.

    STYLING DIRECTION: This is for MPM -- a luxury/premium brands distributor (L'Oreal, Swatch, Kerastase). The auth pages should feel premium, not generic. Dark theme, clean typography, subtle animations. Use CSS transitions on focus states. Avoid the default blue/purple AI-slop look.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Run `npm run build` -- build succeeds.
    Verify `src/components/auth/login-form.tsx` uses 'use client' and imports `useActionState` from `react`.
    Verify login form does NOT have a "Sign Up" or "Register" link.
    Verify `src/app/(auth)/layout.tsx` exists (route group layout).
  </verify>
  <done>
    Auth layout with premium dark theme. Login, reset password, and update password pages with client-side form components. All forms use React 19 useActionState for progressive enhancement. Error handling and loading states implemented. No self-registration link.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. All auth pages render at `/login`, `/reset-password`, `/update-password`
4. Server Actions are properly defined with 'use server'
5. Auth callback route exists at `/auth/callback`
6. Forms use React 19 useActionState (not deprecated useFormState)
7. No "Sign Up" or "Register" links anywhere
</verification>

<success_criteria>
- Login page renders with email/password form at /login
- Reset password page renders with email form at /reset-password
- Update password page renders with new password form at /update-password
- All forms show loading states and error messages
- Auth callback route handles PKCE code exchange
- Logout action redirects to /login
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
