---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - tailwind.config.ts
  - src/app/layout.tsx
  - src/app/globals.css
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/lib/supabase/middleware.ts
  - src/middleware.ts
  - .env.local
  - .env.example
  - .gitignore
  - supabase/migrations/00001_foundation.sql
autonomous: true
user_setup:
  - service: supabase
    why: "Authentication, database, RLS -- entire backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (NEVER expose client-side)"
    dashboard_config:
      - task: "Create a new Supabase project (or use existing)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "After running migration, enable Custom Access Token Hook"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Add Hook -> Token hook -> select custom_access_token_hook function"

must_haves:
  truths:
    - "Next.js 15 app starts with `npm run dev` and serves pages"
    - "Supabase clients (browser, server, admin) are properly configured"
    - "Middleware refreshes auth tokens on every request"
    - "Database has profiles table with RLS policies enabled"
    - "Custom Access Token Hook SQL function exists in migrations"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client using createBrowserClient"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client with cookie handling (async cookies())"
      exports: ["createClient"]
    - path: "src/lib/supabase/admin.ts"
      provides: "Service-role Supabase client for admin operations"
      exports: ["createAdminClient"]
    - path: "src/lib/supabase/middleware.ts"
      provides: "updateSession function for token refresh"
      exports: ["updateSession"]
    - path: "src/middleware.ts"
      provides: "Root middleware calling updateSession"
    - path: "supabase/migrations/00001_foundation.sql"
      provides: "Profiles table, RLS policies, triggers, access token hook"
      contains: "CREATE TABLE public.profiles"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "import { updateSession }"
      pattern: "import.*updateSession.*from.*lib/supabase/middleware"
    - from: "src/lib/supabase/middleware.ts"
      to: "supabase.auth.getUser()"
      via: "token validation on every request"
      pattern: "supabase\\.auth\\.getUser"
    - from: "supabase/migrations/00001_foundation.sql"
      to: "auth.users"
      via: "trigger on_auth_user_created"
      pattern: "CREATE TRIGGER on_auth_user_created"
---

<objective>
Scaffold the Next.js 15 project, install all dependencies, create the three Supabase client utilities (browser, server, admin), configure middleware for auth token refresh, and write the foundation SQL migration (profiles table, RLS policies, triggers, custom access token hook).

Purpose: Every subsequent plan depends on the project existing and Supabase being wired up. This is the bedrock.
Output: Runnable Next.js 15 app with Supabase auth infrastructure ready. SQL migration file for database setup.
</objective>

<execution_context>
@/home/qualia/.claude/get-shit-done/workflows/execute-plan.md
@/home/qualia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project and install dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    .env.local
    .env.example
    .gitignore
  </files>
  <action>
    1. Run `npx create-next-app@15 . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"` in the project root (C:\Users\envy\Desktop\projects\mpm). If it complains about existing files (.gitignore, .planning), accept overwrite or create in temp then move. The project root already has `.planning/` and `.git/` -- preserve both.

    2. Install runtime dependencies:
    ```
    npm install @supabase/supabase-js @supabase/ssr jwt-decode zod
    ```

    3. Create `.env.local` with placeholder values:
    ```
    NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
    NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
    SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
    NEXT_PUBLIC_SITE_URL=http://localhost:3000
    ```
    IMPORTANT: NEVER prefix SUPABASE_SERVICE_ROLE_KEY with NEXT_PUBLIC_.

    4. Create `.env.example` with the same keys but empty values (for documentation).

    5. Ensure `.gitignore` includes:
    - `.env.local`
    - `.env*.local`
    - `node_modules/`
    - `.next/`
    - The `nul` file in the root (artifact from Windows)

    6. Clean up the default page.tsx to show a simple "MPM Employee Discount Platform" heading. Remove the default Next.js boilerplate SVGs and content.

    7. Verify: `npm run dev` starts without errors. `npx tsc --noEmit` passes.
  </action>
  <verify>
    Run `npm run dev` -- server starts on localhost:3000.
    Run `npx tsc --noEmit` -- no TypeScript errors.
    Verify `.env.local` exists and does NOT contain `NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY`.
  </verify>
  <done>
    Next.js 15 app with TypeScript, Tailwind CSS 4, and all Supabase/Zod dependencies installed. Dev server runs. No TS errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client utilities, middleware, and database migration</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/lib/supabase/middleware.ts
    src/middleware.ts
    supabase/migrations/00001_foundation.sql
  </files>
  <action>
    1. Create `src/lib/supabase/client.ts` -- Browser client using `createBrowserClient` from `@supabase/ssr`. Reads `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`. Exports `createClient()`.

    2. Create `src/lib/supabase/server.ts` -- Server client using `createServerClient` from `@supabase/ssr`. MUST use `await cookies()` (Next.js 15 async API). Implements `getAll()` and `setAll()` cookie methods. The `setAll` has a try/catch because it's called from Server Components where cookies can't be set (middleware handles it). Exports async `createClient()`.

    3. Create `src/lib/supabase/admin.ts` -- Service-role client using `createClient` from `@supabase/supabase-js` (NOT `@supabase/ssr`). Uses `SUPABASE_SERVICE_ROLE_KEY` (NO `NEXT_PUBLIC_` prefix). Sets `autoRefreshToken: false` and `persistSession: false`. Add a comment: "Server-only! Never import in client code." Exports `createAdminClient()`.

    4. Create `src/lib/supabase/middleware.ts` -- Exports `updateSession(request: NextRequest)`. Creates a server client using request cookies. Calls `supabase.auth.getUser()` (NOT getSession). Redirects unauthenticated users to `/login` EXCEPT paths starting with: `/login`, `/reset-password`, `/update-password`, `/auth`. Returns the supabaseResponse with updated cookies.

    5. Create `src/middleware.ts` -- Root middleware that imports and calls `updateSession`. Matcher pattern excludes `_next/static`, `_next/image`, `favicon.ico`, and common image extensions.

    6. Create `supabase/migrations/00001_foundation.sql` containing ALL of the following in order:
       a. Create `app_role` enum type: `CREATE TYPE public.app_role AS ENUM ('admin', 'employee');`
       b. Create `profiles` table: id (UUID, FK to auth.users ON DELETE CASCADE, PK), role (app_role, default 'employee'), first_name (TEXT), last_name (TEXT), is_active (BOOLEAN, default true), created_at (TIMESTAMPTZ, default now()), updated_at (TIMESTAMPTZ, default now())
       c. Enable RLS: `ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;`
       d. RLS policies:
          - "Users can view own profile" (SELECT, authenticated, auth.uid() = id)
          - "Admins can view all profiles" (SELECT, authenticated, EXISTS subquery checking caller is admin)
          - "Admins can insert profiles" (INSERT, authenticated, WITH CHECK EXISTS admin check)
          - "Admins can update profiles" (UPDATE, authenticated, USING EXISTS admin check)
       e. `handle_new_user()` trigger function: SECURITY DEFINER, search_path = '', inserts profile row from auth.users metadata. Reads first_name, last_name from raw_user_meta_data. Defaults role to 'employee' via COALESCE.
       f. Trigger `on_auth_user_created` AFTER INSERT on auth.users.
       g. `handle_updated_at()` trigger function for auto-updating updated_at.
       h. Trigger `on_profile_updated` BEFORE UPDATE on profiles.
       i. `custom_access_token_hook(event JSONB)` function: STABLE, reads role from profiles, sets `user_role` claim in JWT. Falls back to 'employee' if no profile found.
       j. GRANT/REVOKE for the hook: grant usage on schema public to supabase_auth_admin, grant execute on the hook to supabase_auth_admin, revoke from authenticated/anon/public, grant all on profiles to supabase_auth_admin.
       k. Policy: "Allow auth admin to read profiles" for supabase_auth_admin.

    Follow the exact SQL patterns from 01-RESEARCH.md. Do NOT deviate from the research.

    7. Verify: `npx tsc --noEmit` passes with all new files.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no errors.
    Verify `src/lib/supabase/server.ts` uses `await cookies()` (async, Next.js 15 pattern).
    Verify `src/lib/supabase/admin.ts` does NOT use `NEXT_PUBLIC_` for service role key.
    Verify `src/middleware.ts` imports from `@/lib/supabase/middleware`.
    Verify `supabase/migrations/00001_foundation.sql` contains `ENABLE ROW LEVEL SECURITY`.
    Verify migration contains `custom_access_token_hook` function.
    Verify migration contains `handle_new_user` trigger.
  </verify>
  <done>
    Three Supabase clients (browser, server, admin) created. Middleware wired for token refresh. SQL migration covers profiles table, RLS policies, all triggers, and custom access token hook. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npx tsc --noEmit` passes
3. All 4 Supabase utility files exist under `src/lib/supabase/`
4. `src/middleware.ts` exists and calls `updateSession`
5. SQL migration file exists at `supabase/migrations/00001_foundation.sql`
6. `.env.local` has correct variable names (no NEXT_PUBLIC_ on service role key)
7. `.gitignore` includes `.env.local`
</verification>

<success_criteria>
- Next.js 15 dev server runs on localhost:3000
- TypeScript compilation has zero errors
- Supabase browser, server, and admin clients are importable
- Middleware intercepts requests and calls getUser() for token validation
- SQL migration is complete and ready to run against a Supabase project
- No secrets exposed in client-accessible code
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
